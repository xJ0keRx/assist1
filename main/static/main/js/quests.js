const surveyConfig = {
  questions: [
    {
      question: "–ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –∏–≥—Ä—ã –≤–∞–º –±–ª–∏–∂–µ?",
      answers: [
        "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–æ–≤—ã–µ –ª–æ—Ç–µ—Ä–µ–∏ (–≤—ã–±–∏—Ä–∞—é —á–∏—Å–ª–∞)",
        "–ë—ã—Å—Ç—Ä—ã–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –ª–æ—Ç–µ—Ä–µ–∏ (—Å–∫—Ä–µ–π—á-–∫–∞—Ä—Ç—ã)",
        "–õ–æ—Ç–µ—Ä–µ–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –±–æ–Ω—É—Å–Ω—ã–º–∏ –∏–≥—Ä–∞–º–∏",
        "–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã, –≥–ª–∞–≤–Ω–æ–µ - —à–∞–Ω—Å –≤—ã–∏–≥—Ä–∞—Ç—å",
      ],
      multiple: false,
    },
    {
      question: "–ö–∞–∫—É—é —Å—É–º–º—É –≤—ã –æ–±—ã—á–Ω–æ –≥–æ—Ç–æ–≤—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –ª–æ—Ç–µ—Ä–µ–π–Ω—ã–π –±–∏–ª–µ—Ç?",
      answers: [
        "–î–æ 300 —Ä—É–±–ª–µ–π",
        "300-500 —Ä—É–±–ª–µ–π",
        "500-1000 —Ä—É–±–ª–µ–π",
        "–ë–æ–ª–µ–µ 1000 —Ä—É–±–ª–µ–π",
      ],
      multiple: false,
    },
    {
      question: "–ù–∞—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–µ–Ω –¥–ª—è –≤–∞—Å —Å—É–ø–µ—Ä–ø—Ä–∏–∑??",
      answers: [
        "–û—á–µ–Ω—å –≤–∞–∂–µ–Ω - –∏–≥—Ä–∞—é —Ç–æ–ª—å–∫–æ –∑–∞ –∫—Ä—É–ø–Ω—ã–π –¥–∂–µ–∫–ø–æ—Ç",
        "–í–∞–∂–µ–Ω, –Ω–æ –Ω–µ–±–æ–ª—å—à–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏ —Ç–æ–∂–µ —Ä–∞–¥—É—é—Ç",
        "–ù–µ –≥–ª–∞–≤–Ω–æ–µ - —á–∞—â–µ –∏–≥—Ä–∞—é —Ä–∞–¥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —ç–º–æ—Ü–∏–π",
        "–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –ª–æ—Ç–µ—Ä–µ–∏ —Å —á–∞—Å—Ç—ã–º–∏, –Ω–æ –º–µ–Ω—å—à–∏–º–∏ –≤—ã–∏–≥—Ä—ã—à–∞–º–∏",
      ],
      multiple: true,
    },
    {
      question: "–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –≥–æ—Ç–æ–≤—ã —É–¥–µ–ª—è—Ç—å –ª–æ—Ç–µ—Ä–µ–µ?",
      answers: [
        "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ - –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "5-15 –º–∏–Ω—É—Ç –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É",
        "–ì–æ—Ç–æ–≤ –∏–∑—É—á–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å",
        "–¢–í—Ä–µ–º—è –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è, –≥–ª–∞–≤–Ω–æ–µ - —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
      ],
      multiple: true,
    },
    {
      question: "–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ –≤ –ø—Ä–∏–∑–∞—Ö?",
      answers: [
        "–¢–æ–ª—å–∫–æ –¥–µ–Ω–µ–∂–Ω—ã–µ –≤—ã–∏–≥—Ä—ã—à–∏",
        "–î–µ–Ω—å–≥–∏ –ø–ª—é—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã",
        "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω–µ–¥–µ–Ω–µ–∂–Ω—ã–µ –ø—Ä–∏–∑—ã (—Ç–µ—Ö–Ω–∏–∫–∞, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è)",
        "–õ—é–±—ã–µ –ø—Ä–∏–∑—ã, –≥–ª–∞–≤–Ω–æ–µ - –≤—ã–∏–≥—Ä—ã–≤–∞—Ç—å",
      ],
      multiple: true,
    },
    {
      question: "–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –∏–≥—Ä–∞—Ç—å?",
      answers: [
        "–ï–∂–µ–¥–Ω–µ–≤–Ω–æ - –±—ã—Å—Ç—Ä—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏",
        "1-2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é - —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –Ω–æ –Ω–µ —á–∞—Å—Ç–æ—Ç",
        "–ü–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é –∏–ª–∏ –æ—Å–æ–±—ã–º —Å–ª—É—á–∞—è–º",
        "–¢–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –∫—Ä—É–ø–Ω—ã–π –¥–∂–µ–∫–ø–æ—Ç",
      ],
      multiple: false,
    },
    {
      question: "–ß—Ç–æ –±–æ–ª—å—à–µ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–∞—Å –∫ –∏–≥—Ä–µ?",
      answers: [
        "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–∏—Ç—å –∂–∏–∑–Ω—å –∫—Ä—É–ø–Ω—ã–º –≤—ã–∏–≥—Ä—ã—à–µ–º",
        "–ê–∑–∞—Ä—Ç –∏ —ç–º–æ—Ü–∏–∏ –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–≥—Ä—ã",
        "–†–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –ø—Ä–∏—è—Ç–Ω–æ–µ –≤—Ä–µ–º—è–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ",
        "–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –∞—Å–ø–µ–∫—Ç - –∏–≥—Ä–∞ —Å –¥—Ä—É–∑—å—è–º–∏/–∫–æ–ª–ª–µ–≥–∞–º–∏",
      ],
      multiple: false,
    },
  ],
};

let currentQuestionIndex = 0;
let selectedAnswers = [];
let userAnswers = [];

const currentQuestionEl = document.getElementById("currentQuestion");
const answersContainerEl = document.getElementById("answersContainer");
const progressFillEl = document.getElementById("progressFill");
const progressPercentEl = document.getElementById("progressPercent");
const continueBtnEl = document.getElementById("continueBtn");

function initSurvey() {
  showQuestion(currentQuestionIndex);
  updateProgress();

  continueBtnEl.addEventListener("click", goToNextQuestion);

  document.body.style.opacity = "0";
  document.body.style.transition = "opacity 0.5s ease";

  setTimeout(() => {
    document.body.style.opacity = "1";
  }, 100);
}

function showQuestion(index) {
  const question = surveyConfig.questions[index];
  selectedAnswers = [];

  currentQuestionEl.textContent = question.question;
  answersContainerEl.innerHTML = "";
  
  question.answers.forEach((answer, answerIndex) => {
    const answerEl = document.createElement("div");
    answerEl.className = "answer-option";
    answerEl.innerHTML = `
          <p class="answer-text">${answer}</p>
        `;

    answerEl.addEventListener("click", () =>
      selectAnswer(answerIndex, answerEl, question.multiple)
    );
    answersContainerEl.appendChild(answerEl);
  });

  continueBtnEl.disabled = !question.multiple;
}

function selectAnswer(answerIndex, answerEl, isMultiple) {
  if (isMultiple) {
    const index = selectedAnswers.indexOf(answerIndex);
    if (index === -1) {
      selectedAnswers.push(answerIndex);
      answerEl.classList.add("selected");
    } else {
      selectedAnswers.splice(index, 1);
      answerEl.classList.remove("selected");
    }
    continueBtnEl.disabled = false;
  } else {
    document.querySelectorAll(".answer-option").forEach((el) => {
      el.classList.remove("selected");
    });
    answerEl.classList.add("selected");
    selectedAnswers = [answerIndex];
    continueBtnEl.disabled = false;
  }
}

function goToNextQuestion() {
  if (selectedAnswers.length === 0) return;

  const currentQuestion = surveyConfig.questions[currentQuestionIndex];
  userAnswers.push({
    question: currentQuestion.question,
    answers: selectedAnswers.map((index) => currentQuestion.answers[index]),
  });

  currentQuestionIndex++;

  if (currentQuestionIndex < surveyConfig.questions.length) {
    showQuestion(currentQuestionIndex);
    updateProgress();
  } else {
    completeSurvey();
  }
}

function updateProgress() {
  const progress = (currentQuestionIndex / surveyConfig.questions.length) * 100;
  progressFillEl.style.width = `${progress}%`;
  progressPercentEl.textContent = `${Math.round(progress)}%`;
}

// –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –û–ü–†–û–°–ê
async function completeSurvey() {
  console.log("–û–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω! –û—Ç–≤–µ—Ç—ã:", userAnswers);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  continueBtnEl.disabled = true;
  continueBtnEl.textContent = "–§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...";

  try {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const response = await fetch('/process-questionnaire/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ answers: userAnswers })
    });

    const data = await response.json();

    if (data.success) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
      currentQuestionEl.textContent = "üéâ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã!";
      answersContainerEl.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
          <p style="font-size: 1.1rem; margin-bottom: 1rem;">–ú—ã –ø–æ–¥–æ–±—Ä–∞–ª–∏ –¥–ª—è –≤–∞—Å ${data.total_found} –ª–æ—Ç–µ—Ä–µ–π</p>
          <p>–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—à–ª–∞ –∏–¥–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</p>
        </div>
      `;
      progressFillEl.style.width = "100%";
      progressPercentEl.textContent = "100%";
      continueBtnEl.textContent = "–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Üí";
      continueBtnEl.disabled = false;

      // –ú–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
      continueBtnEl.onclick = () => {
        window.location.href = "/";
      };
    } else {
      throw new Error(data.error);
    }

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    currentQuestionEl.textContent = "üòï –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞";
    answersContainerEl.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--error);">
        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
      </div>
    `;
    continueBtnEl.textContent = "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é";
    continueBtnEl.onclick = () => {
      window.location.href = "/";
    };
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è CSRF
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener("DOMContentLoaded", initSurvey);